import{_ as r,r as e,o as c,c as t,b as s,a,w as o,d as n,e as i}from"./app-ju10JTa9.js";const D={},d=s("h1",{id:"frp-获取真实-ip",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#frp-获取真实-ip"},[s("span",null,"FRP 获取真实 IP")])],-1),y={class:"table-of-contents"},v=i(`<h2 id="1-http-代理" tabindex="-1"><a class="header-anchor" href="#1-http-代理"><span>1. HTTP 代理</span></a></h2><p>使用 HTTP 代理时，可以通过 <code>X-Forwarded-For</code> 头部获取真实 IP。但是由于 HTTP 代理不够灵活，我们一般直接使用 TCP 代理。</p><h2 id="2-tcp-代理" tabindex="-1"><a class="header-anchor" href="#2-tcp-代理"><span>2. TCP 代理</span></a></h2><p>FRP 支持通过 Proxy Protocol 协议来传递经过 FRP 代理的请求的真实 IP，此功能支持所有以 TCP 为底层协议的类型，不支持 UDP。<sup class="footnote-ref"><a href="#footnote1">[1]</a><a class="footnote-anchor" id="footnote-ref1"></a></sup></p><p>通过指定 <code>proxyProtocolVersion</code> 可以开启 Proxy Protocol，下面是配置示例：</p><div class="language-toml line-numbers-mode" data-ext="toml" data-title="toml"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#9CDCFE;">serverAddr</span><span style="color:#D4D4D4;">  = {{ .Envs.FRP_SERVER_ADDR }</span><span style="color:#F44747;">}</span></span>
<span class="line"><span style="color:#9CDCFE;">serverPort</span><span style="color:#D4D4D4;">  = {{ .Envs.FRP_SERVER_PORT }</span><span style="color:#F44747;">}</span></span>
<span class="line"><span style="color:#9CDCFE;">token</span><span style="color:#D4D4D4;">       = {{ .Envs.FRP_SERVER_TOKEN }</span><span style="color:#F44747;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">[app]</span></span>
<span class="line"><span style="color:#9CDCFE;">type</span><span style="color:#D4D4D4;">        = </span><span style="color:#CE9178;">&quot;tcp&quot;</span></span>
<span class="line"><span style="color:#9CDCFE;">remotePort</span><span style="color:#D4D4D4;">  = </span><span style="color:#B5CEA8;">4090</span></span>
<span class="line"><span style="color:#9CDCFE;">localIp</span><span style="color:#D4D4D4;">     = {{ .Envs.APP_HOST }</span><span style="color:#F44747;">}</span></span>
<span class="line"><span style="color:#9CDCFE;">localPort</span><span style="color:#D4D4D4;">   = </span><span style="color:#B5CEA8;">4090</span></span>
<span class="line"><span style="color:#9CDCFE;">proxyProtocolVersion</span><span style="color:#D4D4D4;"> = </span><span style="color:#CE9178;">&quot;v2&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Nginx 支持 Proxy Protocol，可以通过 <code>proxy_protocol</code> 指令来开启。</p><p>在 <code>listen</code> 指令中添加 <code>proxy_protocol</code> 参数，然后在 <code>location</code> 指令中添加 <code>proxy_set_header</code> 指令来设置 <code>X-Real-IP</code> 和 <code>X-Forwarded-For</code> 头部。</p><div class="language-nginx line-numbers-mode" data-ext="nginx" data-title="nginx"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#569CD6;">http</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;"># ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">server</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">       </span><span style="color:#569CD6;"> listen </span><span style="color:#D4D4D4;">     </span><span style="color:#B5CEA8;">4090</span><span style="color:#D4D4D4;"> proxy_protocol;</span></span>
<span class="line"><span style="color:#D4D4D4;">       </span><span style="color:#569CD6;"> server_name </span><span style="color:#D4D4D4;">www.demo.com;</span></span>
<span class="line"><span style="color:#D4D4D4;">       </span><span style="color:#569CD6;"> client_max_body_size </span><span style="color:#D4D4D4;">128m;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">location</span><span style="color:#D4D4D4;"> / {</span></span>
<span class="line"><span style="color:#D4D4D4;">           </span><span style="color:#569CD6;"> root </span><span style="color:#D4D4D4;">  /usr/share/nginx/html;</span></span>
<span class="line"><span style="color:#D4D4D4;">           </span><span style="color:#569CD6;"> try_files </span><span style="color:#D4D4D4;">$</span><span style="color:#9CDCFE;">uri</span><span style="color:#D4D4D4;"> $</span><span style="color:#9CDCFE;">uri</span><span style="color:#D4D4D4;">/ @router;</span></span>
<span class="line"><span style="color:#D4D4D4;">           </span><span style="color:#569CD6;"> index </span><span style="color:#D4D4D4;"> index.html index.htm;</span></span>
<span class="line"><span style="color:#D4D4D4;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">location</span><span style="color:#D4D4D4;"> @router {</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#569CD6;">rewrite</span><span style="color:#D4D4D4;"> </span><span style="color:#D16969;">^.*$</span><span style="color:#D4D4D4;"> /index.html</span><span style="color:#569CD6;"> last</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">location</span><span style="color:#D4D4D4;"> ^~ </span><span style="color:#D16969;">/api/ </span><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#D4D4D4;">           </span><span style="color:#569CD6;"> proxy_pass </span><span style="color:#D4D4D4;"> http://127.0.0.1:8080/;</span></span>
<span class="line"><span style="color:#D4D4D4;">           </span><span style="color:#569CD6;"> proxy_set_header </span><span style="color:#D4D4D4;">Host $</span><span style="color:#9CDCFE;">host</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">           </span><span style="color:#569CD6;"> proxy_set_header </span><span style="color:#D4D4D4;">X-Real-IP $</span><span style="color:#9CDCFE;">proxy_protocol_addr</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">           </span><span style="color:#569CD6;"> proxy_set_header </span><span style="color:#D4D4D4;">X-Forwarded-For $</span><span style="color:#9CDCFE;">proxy_protocol_addr</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">        }</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="highlight-lines"><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr class="footnotes-sep">`,10),b={class:"footnotes"},u={class:"footnotes-list"},m={id:"footnote1",class:"footnote-item"},h={href:"https://gofrp.org/zh-cn/docs/features/common/realip/",target:"_blank",rel:"noopener noreferrer"},_=s("a",{href:"#footnote-ref1",class:"footnote-backref"},"↩︎",-1);function C(f,x){const l=e("router-link"),p=e("ExternalLinkIcon");return c(),t("div",null,[d,s("nav",y,[s("ul",null,[s("li",null,[a(l,{to:"#1-http-代理"},{default:o(()=>[n("1. HTTP 代理")]),_:1})]),s("li",null,[a(l,{to:"#2-tcp-代理"},{default:o(()=>[n("2. TCP 代理")]),_:1})])])]),v,s("section",b,[s("ol",u,[s("li",m,[s("p",null,[n("获取用户真实 IP，FRP 文档，"),s("a",h,[n("https://gofrp.org/zh-cn/docs/features/common/realip/"),a(p)]),n(),_])])])])])}const P=r(D,[["render",C],["__file","real-ip.html.vue"]]);export{P as default};
